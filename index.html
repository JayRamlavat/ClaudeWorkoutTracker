<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Jay's Tracker" />
  <title>Jay's Workout Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { -webkit-tap-highlight-color: transparent; }
    input, select, textarea { font-size: 16px !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useCallback, useRef, useEffect, useMemo } = React;

    // ---- DEFAULTS ----
    const defaultSettings = {
      wendlerTM: { bench: 205, squat: 290, deadlift: 375, ohp: 120 },
      calisthenics: {
        dips: { top: 80, backoff: 60 },
        pullups: { top: 80, backoff: 60 },
        chinups: { top: 90, backoff: 65 }
      },
      bodyweight: 155
    };

    // ---- HELPERS ----
    const parseFirstNumber = (s) => {
      if (s == null) return null;
      const m = String(s).match(/-?\d+(\.\d+)?/);
      return m ? Number(m[0]) : null;
    };

    const isFilled = (s) => (s ?? "").toString().trim().length > 0;

    // ---- SMART INPUTS ----
    const ExerciseInput = React.memo(({ placeholder, initialValue, lastValue, onSave }) => {
      const [value, setValue] = useState(initialValue);
      const isEditingRef = useRef(false);
      const textareaRef = useRef(null);

      useEffect(() => {
        if (!isEditingRef.current) setValue(initialValue);
      }, [initialValue]);

      useEffect(() => {
        if (textareaRef.current) {
          textareaRef.current.style.height = 'auto';
          textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
        }
      }, [value]);

      const lastW = parseFirstNumber(lastValue);
      const currW = parseFirstNumber(value);
      const delta = (lastW != null && currW != null) ? (currW - lastW) : null;
      const showDelta = delta != null && delta !== 0;
      const deltaClass = !showDelta ? "text-gray-400" : delta > 0 ? "text-green-600" : "text-red-600";

      return (
        <div className="relative">
          <textarea
            ref={textareaRef}
            rows={1}
            placeholder={placeholder}
            value={value}
            onFocus={() => { isEditingRef.current = true; }}
            onChange={e => setValue(e.target.value)}
            onBlur={() => {
              isEditingRef.current = false;
              onSave(value);
            }}
            className="w-full px-2 py-1.5 text-sm border rounded resize-none overflow-hidden block min-h-[34px] leading-snug"
            style={{ paddingRight: isFilled(lastValue) ? '3rem' : '0.5rem' }} 
          />
          {isFilled(lastValue) && (
            <button
              type="button"
              onMouseDown={(e) => e.preventDefault()}
              onClick={() => {
                setValue(lastValue);
                onSave(lastValue);
              }}
              className="absolute right-1 top-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-700 active:bg-gray-200 border"
              title="Copy last set"
            >
              Copy
            </button>
          )}
          <div className={`mt-0.5 text-[10px] font-medium text-right pr-1 ${deltaClass}`}>
            {showDelta ? (delta > 0 ? `+${delta}` : `${delta}`) : (isFilled(lastValue) ? " " : " ")}
          </div>
        </div>
      );
    });

    const NotesInput = React.memo(({ placeholder, initialValue, lastValue, onSave }) => {
      const [value, setValue] = useState(initialValue);
      const isEditingRef = useRef(false);
      const textareaRef = useRef(null);

      useEffect(() => {
        if (!isEditingRef.current) setValue(initialValue);
      }, [initialValue]);

      useEffect(() => {
        if (textareaRef.current) {
          textareaRef.current.style.height = 'auto';
          textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
        }
      }, [value]);

      return (
        <div className="relative mt-2">
          <textarea
            ref={textareaRef}
            rows={1}
            placeholder={placeholder || "Notes..."}
            value={value}
            onFocus={() => { isEditingRef.current = true; }}
            onChange={e => setValue(e.target.value)}
            onBlur={() => {
              isEditingRef.current = false;
              onSave(value);
            }}
            className="w-full px-2 py-1.5 text-sm border rounded resize-none overflow-hidden block min-h-[34px] leading-snug"
            style={{ paddingRight: isFilled(lastValue) ? '3rem' : '0.5rem' }}
          />
          {isFilled(lastValue) && (
            <button
              type="button"
              onMouseDown={(e) => e.preventDefault()}
              onClick={() => {
                setValue(lastValue);
                onSave(lastValue);
              }}
              className="absolute right-1 top-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-700 active:bg-gray-200 border"
              title="Copy last notes"
            >
              Copy
            </button>
          )}
        </div>
      );
    });

    // ---- MAIN APP ----
    const WorkoutTracker = () => {
      
      // -- SMART STARTUP LOGIC --
      const getSmartStart = () => {
        try {
          const comp = JSON.parse(localStorage.getItem('jay-completed-sessions') || '{}');
          for (let w = 1; w <= 8; w++) {
            for (let d = 1; d <= 6; d++) {
              if (!comp[`${w}-${d}`]) {
                return { w, d };
              }
            }
          }
          return { w: 1, d: 1 };
        } catch (e) {
          return { w: 1, d: 1 };
        }
      };

      const startLoc = useMemo(() => getSmartStart(), []);

      // 1. STATE & CONFIG
      const [activeTab, setActiveTab] = useState('workout');
      const [currentWeek, setCurrentWeek] = useState(startLoc.w);
      const [activeDay, setActiveDay] = useState(startLoc.d);
      const [saveStatus, setSaveStatus] = useState('');
      
      // CLOUD CONFIG
      const BASKET_NAME = "jays-workout-tracker";
      const [pantryId, setPantryId] = useState(() => {
        return localStorage.getItem('jay-pantry-id') || '';
      });
      const getCloudUrl = (id) => `https://getpantry.cloud/apiv1/pantry/${id}/basket/${BASKET_NAME}`;

      // 2. DATA STATE
      const [settings, setSettings] = useState(() => {
        try {
          const s = localStorage.getItem('jay-settings');
          return s ? JSON.parse(s) : defaultSettings;
        } catch (e) { return defaultSettings; }
      });

      const [workoutLogs, setWorkoutLogs] = useState(() => {
        try {
          const w = localStorage.getItem('jay-workout-logs');
          return w ? JSON.parse(w) : {};
        } catch(e) { return {}; }
      });

      const [completedSessions, setCompletedSessions] = useState(() => {
        try {
          const c = localStorage.getItem('jay-completed-sessions');
          return c ? JSON.parse(c) : {};
        } catch(e) { return {}; }
      });

      const [bodyweightLogs, setBodyweightLogs] = useState(() => {
        try {
          const b = localStorage.getItem('jay-bodyweight-logs');
          return b ? JSON.parse(b) : [];
        } catch(e) { return []; }
      });

      const [newWeight, setNewWeight] = useState('');
      const [newDate, setNewDate] = useState(new Date().toISOString().split('T')[0]);

      // 3. CLOUD SYNC LOGIC
      useEffect(() => {
        if (!pantryId) return;
        const loadCloudData = async () => {
          try {
            const res = await fetch(getCloudUrl(pantryId));
            if (!res.ok) return; 
            const data = await res.json();
            
            if (data.settings) {
              setSettings(data.settings);
              localStorage.setItem('jay-settings', JSON.stringify(data.settings));
            }
            if (data.logs) {
              setWorkoutLogs(data.logs);
              localStorage.setItem('jay-workout-logs', JSON.stringify(data.logs));
            }
            if (data.completed) {
              setCompletedSessions(data.completed);
              localStorage.setItem('jay-completed-sessions', JSON.stringify(data.completed));
            }
            if (data.bw) {
              setBodyweightLogs(data.bw);
              localStorage.setItem('jay-bodyweight-logs', JSON.stringify(data.bw));
            }
            setSaveStatus('Synced ‚òÅÔ∏è');
            setTimeout(() => setSaveStatus(''), 2000);
          } catch (e) {
            console.error("Cloud load error:", e);
          }
        };
        loadCloudData();
      }, [pantryId]);

      const pushToCloud = (key, data) => {
        if (!pantryId) return;
        fetch(getCloudUrl(pantryId), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [key]: data })
        }).then(() => {
           setSaveStatus('Saved ‚òÅÔ∏è');
           setTimeout(() => setSaveStatus(''), 2000);
        }).catch(() => setSaveStatus('Cloud Error ‚ùå'));
      };

      // 4. SAVE HANDLERS
      const saveTimeout = useRef(null);

      const saveSettingsDebounced = useCallback((s) => {
        setSettings(s);
        localStorage.setItem('jay-settings', JSON.stringify(s));
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => pushToCloud('settings', s), 1000);
      }, [pantryId]);

      const saveLogsDebounced = useCallback((l) => {
        setWorkoutLogs(l);
        localStorage.setItem('jay-workout-logs', JSON.stringify(l));
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => pushToCloud('logs', l), 1000);
      }, [pantryId]);

      const saveCompletion = (c) => {
        setCompletedSessions(c);
        localStorage.setItem('jay-completed-sessions', JSON.stringify(c));
        pushToCloud('completed', c);
      };

      const saveBW = (l) => {
        setBodyweightLogs(l);
        localStorage.setItem('jay-bodyweight-logs', JSON.stringify(l));
        pushToCloud('bw', l);
      };

      const handleFinishDay = () => {
        const key = `${currentWeek}-${activeDay}`;
        const newCompleted = { ...completedSessions, [key]: true };
        saveCompletion(newCompleted);

        let nextW = currentWeek;
        let nextD = activeDay + 1;

        if (nextD > 6) {
          nextD = 1;
          nextW = currentWeek + 1;
        }

        if (nextW > 8) {
          alert("Cycle Complete! Great job.");
          return; 
        }

        setCurrentWeek(nextW);
        setActiveDay(nextD);
        window.scrollTo(0,0);
      };

      // ---- DELETE HELPERS (FIXED) ----
      const deleteDayEntry = (w, d) => {
        if (!confirm(`Are you sure you want to delete logs for Week ${w}, Day ${d}?`)) return;
        
        const key = `${w}-${d}`;
        
        // 1. Remove Logs
        const newLogs = { ...workoutLogs };
        delete newLogs[key];
        saveLogsDebounced(newLogs);

        // 2. Remove Completion
        const newComp = { ...completedSessions };
        delete newComp[key];
        saveCompletion(newComp);
      };

      const deleteWeekEntry = (w) => {
        if (!confirm(`Are you sure you want to delete ALL logs for Week ${w}? This cannot be undone.`)) return;

        const newLogs = { ...workoutLogs };
        const newComp = { ...completedSessions };

        for (let d = 1; d <= 6; d++) {
          const key = `${w}-${d}`;
          delete newLogs[key];
          delete newComp[key];
        }

        saveLogsDebounced(newLogs);
        saveCompletion(newComp);
      };


      // 5. HELPER DATA
      const wendlerStagger = {
        1: { bench: 1, ohp: 3, deadlift: 2, squat: 4 },
        2: { bench: 2, ohp: 4, deadlift: 3, squat: 1 },
        3: { bench: 3, ohp: 1, deadlift: 4, squat: 2 },
        4: { bench: 4, ohp: 2, deadlift: 1, squat: 3 },
        5: { bench: 1, ohp: 3, deadlift: 2, squat: 4 },
        6: { bench: 2, ohp: 4, deadlift: 3, squat: 1 },
        7: { bench: 3, ohp: 1, deadlift: 4, squat: 2 },
        8: { bench: 4, ohp: 2, deadlift: 1, squat: 3 }
      };

      const wendlerPcts = {
        1: [{ p: 0.65, r: '5' }, { p: 0.75, r: '5' }, { p: 0.85, r: '5+' }],
        2: [{ p: 0.70, r: '3' }, { p: 0.80, r: '3' }, { p: 0.90, r: '3+' }],
        3: [{ p: 0.75, r: '5' }, { p: 0.85, r: '3' }, { p: 0.95, r: '1+' }],
        4: [{ p: 0.40, r: '5' }, { p: 0.50, r: '5' }, { p: 0.60, r: '5' }]
      };

      const weekNames = { 1: '5s', 2: '3s', 3: '5/3/1', 4: 'Deload' };
      const calcWt = (tm, p) => Math.round(tm * p / 5) * 5;

      const getChinIntensity = (w) => {
        const ohp = wendlerStagger[w].ohp;
        if (ohp === 4) return { t: 'Push Hard', c: 'bg-green-100 text-green-700' };
        if (ohp === 3) return { t: 'Cap RPE 8', c: 'bg-red-100 text-red-700' };
        return { t: 'Normal', c: 'bg-gray-100 text-gray-700' };
      };

      const dayEx = {
        1: [
          { id: 'bench', n: 'Bench Press (Wendler)', w: true, wl: 'bench', s: 3, r: 'cycle', nt: 'AMRAP last set' },
          { id: 'd1_tbar', n: 'T-Bar Rows', s: 2, r: '4-6', nt: 'Full ROM' },
          { id: 'd1_inc', n: 'Incline DB Press', s: 2, r: '5-9', nt: 'Tucked elbows' },
          { id: 'd1_curl', n: 'EZ Bar Curls', s: 2, r: '6-10', nt: 'Short head' },
          { id: 'd1_push', n: 'Seated Pushdown Machine', s: 3, r: '6-10', nt: 'Lateral/medial' },
          { id: 'd1_lat', n: 'Lateral Raises', s: 2, r: '8-12', nt: 'Side delt' },
          { id: 'd1_calf', n: 'Leg Press Calf Raises', s: 2, r: '12-15', nt: 'Full ROM' }
        ],
        2: [
          { id: 'dead', n: 'Deadlift (Wendler)', w: true, wl: 'deadlift', s: 3, r: 'cycle', nt: 'AMRAP last set' },
          { id: 'd2_pause', n: 'Pause Squat', s: 2, r: '3-5', nt: '2s pause' },
          { id: 'd2_calf', n: 'Seated Calf Raises', s: 3, r: '12-20', nt: 'Soleus' },
          { id: 'd2_ham', n: 'Hamstring Curls', s: 1, r: '8-10', nt: 'Maintenance' },
          { id: 'd2_rdl', n: 'Single-Leg RDL', s: 1, r: '8-10', nt: 'RIGHT first' },
          { id: 'd2_rot', n: 'External Rotations', s: 2, r: '6-10', nt: 'Prehab' },
          { id: 'd2_drag', n: 'Dragon Flags', s: 2, r: '5-8', nt: 'Lower abs' }
        ],
        3: [
          { id: 'dip_t', n: 'Weighted Dips (Top)', c: true, ct: 'dips', st: 'top', s: 1, r: '3-5', nt: 'Near failure' },
          { id: 'dip_b', n: 'Weighted Dips (Back-off)', c: true, ct: 'dips', st: 'backoff', s: 2, r: '6-8', nt: '~75% top' },
          { id: 'd3_preach', n: 'Preacher Curl Machine', s: 3, r: '6-10', nt: 'Short head' },
          { id: 'd3_oh', n: 'OH Cable Extensions', s: 3, r: '10-15', nt: 'Long head' },
          { id: 'd3_inc', n: 'Incline DB Curls', s: 3, r: '8-12', nt: 'Long head' },
          { id: 'd3_lat', n: 'Cable Lateral Raises', s: 3, r: '10-12', nt: 'Side delt' },
          { id: 'd3_rev', n: 'Reverse Pec Deck', s: 3, r: '8-12', nt: 'Rear delt' }
        ],
        4: [
          { id: 'pull_t', n: 'Weighted Pull-ups (Top)', c: true, ct: 'pullups', st: 'top', s: 1, r: '3-5', nt: 'Near failure' },
          { id: 'pull_b', n: 'Weighted Pull-ups (Back-off)', c: true, ct: 'pullups', st: 'backoff', s: 2, r: '6-8', nt: '~75% top' },
          { id: 'd4_flat', n: 'Flat DB Press', s: 2, r: '4-8', nt: '45¬∞ elbows' },
          { id: 'd4_row', n: 'Barbell Row', s: 2, r: '5-8', nt: 'Pause reps' },
          { id: 'd4_inc', n: 'Incline Press Machine', s: 2, r: '6-10', nt: 'Chest' },
          { id: 'd4_pec', n: 'Pec Deck', s: 2, r: '8-11', nt: 'Isolation' },
          { id: 'd4_ql', n: 'QL Extensions', s: 1, r: '12-15', nt: 'LEFT first' }
        ],
        5: [
          { id: 'squat', n: 'Back Squat (Wendler)', w: true, wl: 'squat', s: 3, r: 'cycle', nt: 'AMRAP last set' },
          { id: 'd5_rdl', n: 'Romanian Deadlift', s: 2, r: '3-6', nt: 'Posterior chain' },
          { id: 'd5_ext', n: 'Leg Extensions', s: 2, r: '6-10', nt: 'Quad maintenance' },
          { id: 'd5_calf', n: 'Standing Calf Raises', s: 3, r: '8-15', nt: 'Gastrocnemius' },
          { id: 'd5_leg', n: 'Leg Raises', s: 2, r: '6-10', nt: 'Lower abs' },
          { id: 'd5_abs', n: 'Abs Machine', s: 2, r: '6-10', nt: 'Core' }
        ],
        6: [
          { id: 'chin_t', n: 'Weighted Chin-ups (Top)', c: true, ct: 'chinups', st: 'top', s: 1, r: '3-5', nt: 'See intensity' },
          { id: 'chin_b', n: 'Weighted Chin-ups (Back-off)', c: true, ct: 'chinups', st: 'backoff', s: 2, r: '6-8', nt: '~75% top' },
          { id: 'ohp', n: 'OHP (Wendler)', w: true, wl: 'ohp', s: 3, r: 'cycle', nt: 'AMRAP last set' },
          { id: 'd6_vbar', n: 'V-Bar Pushdowns', s: 3, r: '6-10', nt: 'Lateral/medial' },
          { id: 'd6_bay', n: 'Bayesian Curls', s: 3, r: '10-15', nt: 'Long head' },
          { id: 'd6_spider', n: 'Spider Curls', s: 2, r: '8-12', nt: 'Short head' },
          { id: 'd6_lat', n: 'Machine Lateral Raises', s: 2, r: '6-10', nt: 'Side delt' },
          { id: 'd6_face', n: 'Face Pulls', s: 2, r: '12-15', nt: 'Rear delt' }
        ]
      };

      const dayNames = {
        1: 'D1: Chest+Back+Arms',
        2: 'D2: Lower+Core',
        3: 'D3: Arms+Delts',
        4: 'D4: Chest+Back Vol',
        5: 'D5: Lower Maint',
        6: 'D6: Arms+Delts'
      };

      const logSet = (w, d, ex, i, v) => {
        const k = `${w}-${d}`;
        const nl = { ...workoutLogs };
        if (!nl[k]) nl[k] = {};
        if (!nl[k][ex]) nl[k][ex] = { sets: [], notes: '' };
        nl[k][ex].sets[i] = v;
        saveLogsDebounced(nl);
      };

      const logNotes = (w, d, ex, v) => {
        const k = `${w}-${d}`;
        const nl = { ...workoutLogs };
        if (!nl[k]) nl[k] = {};
        if (!nl[k][ex]) nl[k][ex] = { sets: [], notes: '' };
        nl[k][ex].notes = v;
        saveLogsDebounced(nl);
      };

      const getLog = (w, d, ex) => workoutLogs[`${w}-${d}`]?.[ex] || { sets: [], notes: '' };

      const getPrevLog = (w, d, ex) => {
        for (let wk = w - 1; wk >= 1; wk--) {
          const log = workoutLogs[`${wk}-${d}`]?.[ex];
          const hasSets = log?.sets?.some(s => isFilled(s));
          const hasNotes = isFilled(log?.notes);
          if (hasSets || hasNotes) return { ...log, _week: wk };
        }
        return { sets: [], notes: '', _week: null };
      };

      // ---- RENDER FUNCTIONS ----
      const renderSetupTab = () => (
        <div className="p-4 space-y-4">
          
          {/* CLOUD SYNC SECTION */}
          <div className="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
            <h2 className="font-bold text-gray-800 mb-2">Cloud Sync Setup</h2>
            <p className="text-xs text-gray-500 mb-2">
              To sync across devices, create a free bucket at <a href="https://getpantry.cloud" target="_blank" className="text-blue-600 underline">getpantry.cloud</a> and paste your ID here.
            </p>
            <input
              type="text"
              placeholder="Paste Pantry ID here..."
              value={pantryId}
              onChange={(e) => {
                const newId = e.target.value.trim();
                setPantryId(newId);
                localStorage.setItem('jay-pantry-id', newId);
              }}
              className="w-full px-3 py-2 border rounded-md text-sm font-mono"
            />
            {pantryId && <p className="text-xs text-green-600 mt-2 font-bold">Sync Active ‚úì</p>}
          </div>

          {/* MANUAL BACKUP SECTION */}
          <div className="bg-white rounded-lg shadow p-4 border-l-4 border-gray-500">
            <h2 className="font-bold text-gray-800 mb-2">Data Backup</h2>
            <div className="grid grid-cols-2 gap-3">
              <button
                onClick={() => {
                  const data = { settings, logs: workoutLogs, bw: bodyweightLogs, completed: completedSessions };
                  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `jay-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                }}
                className="w-full bg-green-600 text-white py-2 rounded-md text-sm font-medium active:bg-green-700"
              >
                Export Backup
              </button>

              <div className="relative">
                <input
                  type="file"
                  accept=".json"
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                  onChange={(e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                      try {
                        const data = JSON.parse(event.target.result);
                        if (data.settings) {
                          setSettings(data.settings);
                          localStorage.setItem('jay-settings', JSON.stringify(data.settings));
                        }
                        if (data.logs) {
                          setWorkoutLogs(data.logs);
                          localStorage.setItem('jay-workout-logs', JSON.stringify(data.logs));
                        }
                        if (data.completed) {
                          setCompletedSessions(data.completed);
                          localStorage.setItem('jay-completed-sessions', JSON.stringify(data.completed));
                        }
                        if (data.bw) {
                          setBodyweightLogs(data.bw);
                          localStorage.setItem('jay-bodyweight-logs', JSON.stringify(data.bw));
                        }
                        alert('Data restored! Refreshing...');
                        window.location.reload();
                      } catch (err) {
                        alert('Invalid backup file');
                      }
                    };
                    reader.readAsText(file);
                  }}
                />
                <button className="w-full bg-gray-600 text-white py-2 rounded-md text-sm font-medium pointer-events-none">
                  Import Backup
                </button>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="font-bold text-gray-800 mb-3">Wendler TMs (lbs)</h2>
            <div className="grid grid-cols-2 gap-3">
              {['bench', 'squat', 'deadlift', 'ohp'].map(l => (
                <div key={l}>
                  <label className="text-sm text-gray-600 capitalize">{l === 'ohp' ? 'OHP' : l}</label>
                  <input
                    type="number"
                    value={settings.wendlerTM[l]}
                    onChange={e => saveSettingsDebounced({ ...settings, wendlerTM: { ...settings.wendlerTM, [l]: +e.target.value } })}
                    className="w-full mt-1 px-3 py-2 border rounded-md"
                  />
                </div>
              ))}
            </div>
          </div>
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="font-bold text-gray-800 mb-3">Calisthenics (lbs)</h2>
            {['dips', 'pullups', 'chinups'].map(ex => (
              <div key={ex} className="mb-3">
                <label className="text-sm text-gray-600 capitalize">
                  {ex === 'pullups' ? 'Pull-ups' : ex === 'chinups' ? 'Chin-ups' : 'Dips'}
                </label>
                <div className="grid grid-cols-2 gap-2 mt-1">
                  <div>
                    <span className="text-xs text-gray-400">Top</span>
                    <input
                      type="number"
                      value={settings.calisthenics[ex].top}
                      onChange={e => saveSettingsDebounced({
                        ...settings,
                        calisthenics: {
                          ...settings.calisthenics,
                          [ex]: { ...settings.calisthenics[ex], top: +e.target.value }
                        }
                      })}
                      className="w-full px-3 py-2 border rounded-md"
                    />
                  </div>
                  <div>
                    <span className="text-xs text-gray-400">Back-off</span>
                    <input
                      type="number"
                      value={settings.calisthenics[ex].backoff}
                      onChange={e => saveSettingsDebounced({
                        ...settings,
                        calisthenics: {
                          ...settings.calisthenics,
                          [ex]: { ...settings.calisthenics[ex], backoff: +e.target.value }
                        }
                      })}
                      className="w-full px-3 py-2 border rounded-md"
                    />
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );

      const renderWendlerTab = () => (
        <div className="p-4 space-y-4">
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="font-bold text-gray-800 mb-3">8-Week Stagger</h2>
            <div className="overflow-x-auto">
              <table className="w-full text-xs">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="px-2 py-1">Wk</th>
                    <th className="px-2 py-1">Bench</th>
                    <th className="px-2 py-1">OHP</th>
                    <th className="px-2 py-1">Dead</th>
                    <th className="px-2 py-1">Squat</th>
                    <th className="px-2 py-1">Chins</th>
                  </tr>
                </thead>
                <tbody>
                  {[1,2,3,4,5,6,7,8].map(wk => {
                    const st = wendlerStagger[wk];
                    const chin = getChinIntensity(wk);
                    const isWkComplete = [1,2,3,4,5,6].every(d => completedSessions[`${wk}-${d}`]);
                    return (
                      <tr key={wk} className={wk === currentWeek ? 'bg-blue-50' : ''}>
                        <td className="px-2 py-1 font-medium text-center relative">
                          {wk}
                          {isWkComplete && <span className="absolute top-0 right-0 text-[8px] text-green-600">‚úì</span>}
                        </td>
                        {['bench','ohp','deadlift','squat'].map(l => (
                          <td key={l} className={`px-2 py-1 text-center ${st[l]===3?'bg-red-100 text-red-700 font-medium':st[l]===4?'bg-green-100 text-green-700':''}`}>
                            {weekNames[st[l]]}
                          </td>
                        ))}
                        <td className={`px-2 py-1 text-center ${chin.c}`}>{chin.t}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          {['bench','squat','deadlift','ohp'].map(lift => (
            <div key={lift} className="bg-white rounded-lg shadow p-4">
              <h3 className="font-bold text-gray-700 capitalize mb-2">
                {lift === 'ohp' ? 'OHP' : lift} ‚Äî TM: {settings.wendlerTM[lift]}
              </h3>
              <table className="w-full text-xs">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="px-2 py-1">Wk</th>
                    <th className="px-2 py-1">Phase</th>
                    <th className="px-2 py-1">Set 1</th>
                    <th className="px-2 py-1">Set 2</th>
                    <th className="px-2 py-1">Set 3</th>
                  </tr>
                </thead>
                <tbody>
                  {[1,2,3,4,5,6,7,8].map(wk => {
                    const ph = wendlerStagger[wk][lift];
                    const pcts = wendlerPcts[ph];
                    return (
                      <tr key={wk} className={wk === currentWeek ? 'bg-blue-50' : ''}>
                        <td className="px-2 py-1 text-center">{wk}</td>
                        <td className={`px-2 py-1 text-center ${ph===3?'bg-red-100 text-red-700':ph===4?'bg-green-100 text-green-700':''}`}>
                          {weekNames[ph]}
                        </td>
                        {pcts.map((s,i) => (
                          <td key={i} className="px-2 py-1 text-center">
                            {calcWt(settings.wendlerTM[lift], s.p)}√ó{s.r}
                          </td>
                        ))}
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          ))}
        </div>
      );

      const renderWorkoutTab = () => {
        const exs = dayEx[activeDay];
        const st = wendlerStagger[currentWeek];
        const chin = getChinIntensity(currentWeek);

        const renderLastSessionBox = (prev, faded) => {
          const setsText = (prev.sets || []).filter(s => isFilled(s)).join(' / ');
          const notesText = (prev.notes || '').toString().trim();
          if (!setsText && !notesText) return null;

          return (
            <div className={`mt-2 p-2 rounded bg-gray-50 border-l-4 border-gray-300 text-xs text-gray-600 ${faded ? "opacity-35" : "opacity-100"}`}>
              <span className="font-medium">Last session{prev._week ? ` (W${prev._week})` : ""}:</span>
              {setsText && <span className="ml-1">{setsText}</span>}
              {setsText && notesText && <span className="mx-1">‚Ä¢</span>}
              {notesText && <span className="italic">{notesText}</span>}
            </div>
          );
        };

        const isCompleted = completedSessions[`${currentWeek}-${activeDay}`];

        return (
          <div className="p-4 space-y-4">
            <div className="bg-white rounded-lg shadow p-3">
              <label className="text-sm text-gray-600">Week</label>
              <select
                value={currentWeek}
                onChange={e => setCurrentWeek(+e.target.value)}
                className="w-full mt-1 px-3 py-2 border rounded-md"
              >
                {[1,2,3,4,5,6,7,8].map(w => <option key={w} value={w}>Week {w}</option>)}
              </select>
            </div>

            <div className="bg-white rounded-lg shadow overflow-hidden">
              <div className="flex border-b overflow-x-auto">
                {[1,2,3,4,5,6].map(d => (
                  <button
                    key={d}
                    onClick={() => setActiveDay(d)}
                    className={`relative px-4 py-2 text-sm font-medium whitespace-nowrap ${activeDay===d?'bg-blue-50 text-blue-600 border-b-2 border-blue-500':'text-gray-500'}`}
                  >
                    D{d}
                    {completedSessions[`${currentWeek}-${d}`] && <span className="ml-1 text-[10px] text-green-500">‚úì</span>}
                  </button>
                ))}
              </div>

              <div className="p-4">
                <div className="flex justify-between items-center mb-3">
                  <div>
                    <h2 className="font-bold text-gray-800">{dayNames[activeDay]}</h2>
                    <p className="text-xs text-gray-500">Week {currentWeek}</p>
                  </div>
                  {isCompleted && (
                    <span className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold border border-green-200">
                      COMPLETED
                    </span>
                  )}
                </div>

                {activeDay === 6 && (
                  <div className={`mb-3 p-2 rounded text-sm ${chin.c}`}>
                    <b>Chin-ups:</b> {chin.t}
                  </div>
                )}

                <div className="space-y-3">
                  {exs.map(ex => {
                    const log = getLog(currentWeek, activeDay, ex.id);
                    const prev = getPrevLog(currentWeek, activeDay, ex.id);
                    const allFilled = Array.from({ length: ex.s }, (_, i) => isFilled(log.sets?.[i])).every(Boolean);

                    let tgt = '';
                    if (ex.w) {
                      const ph = st[ex.wl];
                      tgt = wendlerPcts[ph].map(s => `${calcWt(settings.wendlerTM[ex.wl], s.p)}√ó${s.r}`).join(' / ');
                    } else if (ex.c) {
                      tgt = `${settings.calisthenics[ex.ct][ex.st]} lbs`;
                    }

                    return (
                      <div key={ex.id} className={`border rounded-lg p-3 ${isCompleted ? 'bg-gray-50 opacity-80' : ''}`}>
                        <div className="flex justify-between">
                          <h3 className={`font-medium text-sm ${ex.w || ex.c ? 'text-blue-700' : 'text-gray-800'}`}>{ex.n}</h3>
                          <span className="text-xs text-gray-400">{ex.s}√ó{ex.r}</span>
                        </div>

                        {tgt && <p className="text-xs text-blue-600 mt-1">Target: {tgt}</p>}
                        <p className="text-xs text-gray-400">{ex.nt}</p>

                        {renderLastSessionBox(prev, allFilled)}

                        <div className="grid grid-cols-3 gap-2 mt-2">
                          {Array.from({ length: ex.s }, (_, i) => (
                            <ExerciseInput
                              key={`${ex.id}-${i}`}
                              initialValue={log.sets?.[i] || ''}
                              lastValue={prev.sets?.[i] || ''}
                              placeholder={prev.sets?.[i] ? `Last: ${prev.sets[i]}` : `Set ${i + 1}`}
                              onSave={(v) => logSet(currentWeek, activeDay, ex.id, i, v)}
                            />
                          ))}
                        </div>

                        <NotesInput
                          key={`${ex.id}-notes`}
                          initialValue={log.notes || ''}
                          lastValue={prev.notes || ''}
                          placeholder={prev.notes ? `Last: ${prev.notes}` : "Notes..."}
                          onSave={(v) => logNotes(currentWeek, activeDay, ex.id, v)}
                        />
                      </div>
                    );
                  })}
                </div>

                {/* FINISH WORKOUT BUTTON */}
                <div className="mt-8">
                  <button
                    onClick={handleFinishDay}
                    className="w-full py-4 rounded-lg bg-green-600 active:bg-green-700 text-white font-bold text-lg shadow-lg flex justify-center items-center gap-2"
                  >
                    <span>{isCompleted ? "Update & Next" : "Finish Workout"}</span>
                    <span>‚Üí</span>
                  </button>
                  <p className="text-center text-xs text-gray-400 mt-2">
                    Marks Day {activeDay} as done and loads Day {activeDay < 6 ? activeDay + 1 : 1}
                  </p>
                </div>

              </div>
            </div>
          </div>
        );
      };

      const renderHistoryTab = () => (
        <div className="p-4">
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="font-bold text-gray-800 mb-4">Workout History</h2>
            {[8,7,6,5,4,3,2,1].map(wk => {
              const hasData = [1,2,3,4,5,6].some(d => workoutLogs[`${wk}-${d}`] && Object.keys(workoutLogs[`${wk}-${d}`]).length > 0);
              if (!hasData) return null;
              return (
                <div key={wk} className="mb-4 pb-4 border-b">
                  {/* WEEK HEADER + DELETE BUTTON */}
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-gray-700">Week {wk}</h3>
                    <button 
                      onClick={() => deleteWeekEntry(wk)}
                      className="text-red-500 text-lg px-2"
                      title="Delete all data for this week"
                    >
                      üóëÔ∏è
                    </button>
                  </div>

                  {[1,2,3,4,5,6].map(d => {
                    const data = workoutLogs[`${wk}-${d}`];
                    if (!data || Object.keys(data).length === 0) return null;
                    const isDone = completedSessions[`${wk}-${d}`];
                    return (
                      <div key={d} className="ml-2 mb-2">
                        {/* DAY HEADER + DELETE BUTTON */}
                        <div className="flex items-center gap-2">
                          <h4 className="text-sm font-medium text-gray-600 flex items-center gap-2">
                            {dayNames[d]}
                            {isDone && <span className="text-[10px] bg-green-100 text-green-700 px-1 rounded">DONE</span>}
                          </h4>
                          <button 
                            onClick={() => deleteDayEntry(wk, d)}
                            className="text-red-400 text-xs px-1 hover:text-red-600 font-bold"
                            title="Delete this day"
                          >
                            ‚úï
                          </button>
                        </div>
                        
                        {Object.entries(data).map(([id, v]) => {
                          const ex = dayEx[d]?.find(e => e.id === id);
                          if (!ex || !v.sets.filter(s=>s).length) return null;
                          return <p key={id} className="text-xs text-gray-500 ml-2">{ex.n}: {v.sets.filter(s=>s).join(' / ')}{v.notes && ` (${v.notes})`}</p>;
                        })}
                      </div>
                    );
                  })}
                </div>
              );
            })}
            {Object.keys(workoutLogs).length === 0 && <p className="text-gray-400 text-center py-8">No history yet</p>}
          </div>
        </div>
      );

      const renderBodyweightTab = () => (
        <div className="p-4 space-y-4">
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="font-bold text-gray-800 mb-3">Log Bodyweight</h2>
            <div className="grid grid-cols-2 gap-3 mb-3">
              <input type="number" step="0.1" placeholder="Weight (lbs)" value={newWeight} onChange={e => setNewWeight(e.target.value)} className="px-3 py-2 border rounded-md"/>
              <input type="date" value={newDate} onChange={e => setNewDate(e.target.value)} className="px-3 py-2 border rounded-md"/>
            </div>
            <button onClick={() => {
              if (newWeight) {
                const nl = [...bodyweightLogs, {weight: +newWeight, date: newDate}].sort((a,b) => new Date(a.date) - new Date(b.date));
                saveBW(nl);
                setNewWeight('');
              }
            }} className="w-full bg-blue-600 text-white py-2 rounded-md active:bg-blue-700">Log Weight</button>
          </div>
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="font-bold text-gray-800 mb-3">History</h2>
            {bodyweightLogs.length > 0 ? (
              [...bodyweightLogs].reverse().map((e, i) => (
                <div key={i} className="flex justify-between py-2 border-b text-sm">
                  <span className="text-gray-600">{e.date}</span>
                  <span className="font-medium">{e.weight} lbs</span>
                </div>
              ))
            ) : <p className="text-gray-400 text-center py-4">No entries</p>}
          </div>
          {bodyweightLogs.length >= 2 && (
            <div className="bg-white rounded-lg shadow p-4">
              <h2 className="font-bold text-gray-800 mb-2">Trend</h2>
              <div className="text-sm space-y-1">
                <div className="flex justify-between"><span>Start:</span><span>{bodyweightLogs[0].weight} lbs</span></div>
                <div className="flex justify-between"><span>Current:</span><span>{bodyweightLogs[bodyweightLogs.length-1].weight} lbs</span></div>
                <div className="flex justify-between border-t pt-1"><span>Change:</span>
                  <span className={bodyweightLogs[bodyweightLogs.length-1].weight >= bodyweightLogs[0].weight ? 'text-green-600' : 'text-red-600'}>
                    {(bodyweightLogs[bodyweightLogs.length-1].weight - bodyweightLogs[0].weight) >= 0 ? '+' : ''}
                    {(bodyweightLogs[bodyweightLogs.length-1].weight - bodyweightLogs[0].weight).toFixed(1)} lbs
                  </span>
                </div>
              </div>
            </div>
          )}
        </div>
      );

      return (
        <div className="min-h-screen bg-gray-100">
          <div className="bg-blue-700 text-white p-4 flex justify-between items-center">
            <div>
              <h1 className="text-lg font-bold">Jay's Workout Tracker</h1>
              <p className="text-blue-200 text-xs">Staggered Wendler + Weighted Calisthenics</p>
            </div>
            {saveStatus && <span className="text-green-300 text-sm">{saveStatus}</span>}
          </div>

          <div className="pb-20">
            {activeTab === 'setup' && renderSetupTab()}
            {activeTab === 'wendler' && renderWendlerTab()}
            {activeTab === 'workout' && renderWorkoutTab()}
            {activeTab === 'history' && renderHistoryTab()}
            {activeTab === 'bodyweight' && renderBodyweightTab()}
          </div>

          <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex safe-area-inset-bottom">
            {[
              {id: 'workout', l: 'Workout', i: 'üèãÔ∏è'},
              {id: 'wendler', l: 'Wendler', i: 'üìä'},
              {id: 'history', l: 'History', i: 'üìú'},
              {id: 'bodyweight', l: 'Weight', i: '‚öñÔ∏è'},
              {id: 'setup', l: 'Setup', i: '‚öôÔ∏è'}
            ].map(t => (
              <button key={t.id} onClick={() => setActiveTab(t.id)}
                className={`flex-1 py-3 text-center ${activeTab === t.id ? 'text-blue-600 bg-blue-50' : 'text-gray-500'}`}>
                <div className="text-xl">{t.i}</div>
                <div className="text-xs">{t.l}</div>
              </button>
            ))}
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<WorkoutTracker />);
  </script>
</body>
</html>
